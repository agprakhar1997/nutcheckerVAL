<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roboflow PASS/FAIL Detection</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 800px;
      width: 100%;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    video, canvas, img {
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .button-group {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    .start-btn { background: #28a745; color: white; }
    .stop-btn { background: #dc3545; color: white; }
    .status {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .status.pass { background: #d4edda; color: #155724; }
    .status.fail { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    #results img {
      margin-top: 20px;
      border-radius: 10px;
    }
    details {
      margin-top: 20px;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    #results canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Roboflow Workflow Status Detection</h2>
    </div>
    <video id="videoElement" autoplay playsinline muted></video>
    <canvas id="canvasElement" style="display:none;"></canvas>
    <div class="button-group">
      <button class="start-btn" id="startBtn" onclick="startCamera()">Start</button>
      <button class="stop-btn" id="stopBtn" onclick="stopCamera()" disabled>Stop</button>
    </div>
    <div id="statusBox" class="status info">Waiting to start...</div>
    <div id="results"></div>
    <details>
      <summary>API Response (Debug)</summary>
      <pre id="apiResponse"></pre>
    </details>
  </div>

  <script>
    const API_URL = 'https://detect.roboflow.com/YOUR_PROJECT/1?api_key=YOUR_API_KEY';
    let videoStream = null;
    let detectionInterval = null;
    const detectionFrequency = 3000;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
        .then(stream => {
          videoStream = stream;
          document.getElementById('videoElement').srcObject = stream;
          document.getElementById('startBtn').disabled = true;
          document.getElementById('stopBtn').disabled = false;
          showStatus('Camera started. Scanning...', 'info');
          detectionInterval = setInterval(captureFrame, detectionFrequency);
        });
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      if (detectionInterval) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      showStatus('Camera stopped.', 'info');
    }

    function captureFrame() {
      const video = document.getElementById('videoElement');
      const canvas = document.getElementById('canvasElement');
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imgData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

      fetch(API_URL, {
        method: 'POST',
        body: imgData,
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
        handleResults(data, canvas);
      })
      .catch(err => showStatus('Error: ' + err.message, 'fail'));
    }

    function handleResults(data, sourceCanvas) {
      const outputs = Object.values(data.outputs || {});
      for (const output of outputs) {
        if (output.status_output && (output.status_output.toLowerCase() === 'pass' || output.status_output.toLowerCase() === 'fail')) {
          showStatus(`Result: ${output.status_output.toUpperCase()}`, output.status_output.toLowerCase());
          stopCamera();
          displayFinalCanvas(sourceCanvas, output.predictions);
          return;
        }
      }
    }

    function displayFinalCanvas(sourceCanvas, predictions) {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = sourceCanvas.width;
      canvas.height = sourceCanvas.height;
      ctx.drawImage(sourceCanvas, 0, 0);

      if (predictions && predictions.length > 0) {
        const avgConf = predictions.reduce((sum, p) => sum + (p.confidence || 0), 0) / predictions.length;
        const confDiv = document.createElement('div');
        confDiv.innerHTML = `<strong>Average Confidence:</strong> ${(avgConf * 100).toFixed(2)}%`;
        resultsDiv.appendChild(confDiv);

        predictions.forEach(pred => {
          const x = pred.x - pred.width / 2;
          const y = pred.y - pred.height / 2;
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, pred.width, pred.height);

          ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
          ctx.fillRect(x, y - 20, ctx.measureText(pred.class).width + 10, 20);
          ctx.fillStyle = '#fff';
          ctx.fillText(`${pred.class} (${(pred.confidence * 100).toFixed(1)}%)`, x + 5, y - 5);
        });
      }

      resultsDiv.appendChild(canvas);
    }

    function showStatus(text, type) {
      const box = document.getElementById('statusBox');
      box.textContent = text;
      box.className = `status ${type}`;
    }
  </script>
</body>
</html>
